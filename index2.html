<!DOCTYPE html>
<html lang="en">

<head>
    <title>Video Broadcasting</title>

    <script>
        document.createElement("article");
    </script>

    <!-- This Library is used to detect WebRTC features -->
    <script src="https://www.webrtc-experiment.com/DetectRTC.js"></script>

    <script src="https://www.webrtc-experiment.com/socket.io.js"></script>
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <script src="IceServersHandler.js"></script>
    <script src="https://www.webrtc-experiment.com/CodecsHandler.js"></script>
    <script src="RTCPeerConnection.js"></script>
    <script src="https://www.webrtc-experiment.com/webrtc-broadcasting/broadcast.js"></script>
    <script>
        function getUrlVars() {
            var vars = {};
            var parts = window.location.href.replace(
                /[?&]+([^=&]+)=([^&]*)/gi,
                function(m, key, value) {
                    vars[key] = value;
                }
            );
            return vars;
        }
    </script>
</head>

<body>
    <article>
        <section class="experiment">
            <section>
                <select style="display: none;" id="broadcasting-option">
            <option>Video</option>
            <option>Screen</option>
          </select>
                <input style="display: none;" type="text" id="broadcast-name" />
                <button style="display: none;" id="setup-new-broadcast" class="setup">
            Setup New Broadcast
          </button>
            </section>

            <!-- list of all available broadcasting rooms -->
            <table style="display: none;" id="rooms-list"></table>

            <!-- local/remote videos container -->
            <div id="videos-container"></div>
        </section>

        <script>
            // Muaz Khan     - https://github.com/muaz-khan
            // MIT License   - https://www.webrtc-experiment.com/licence/
            // Documentation - https://github.com/muaz-khan/WebRTC-Experiment/tree/master/webrtc-broadcasting
            var config = {
                openSocket: function(config) {
                    var SIGNALING_SERVER = "https://signalling-kro-g.herokuapp.com/";
                    config.channel = getUrlVars()["id"];
                    var sender = getUrlVars()["u"];
                    io.connect(SIGNALING_SERVER).emit("new-channel", {
                        channel: config.channel,
                        sender: sender,
                    });
                    var socket = io.connect(SIGNALING_SERVER + config.channel);
                    socket.channel = config.channel;
                    socket.on("connect", function() {
                        if (config.callback) config.callback(socket);
                    });
                    socket.send = function(message) {
                        socket.emit("message", {
                            sender: sender,
                            data: message,
                        });
                    };
                    socket.on("message", config.onmessage);
                },
                onRemoteStream: function(htmlElement) {
                    console.log("Here");
                    htmlElement.setAttribute("id", "getvideo");
                    videosContainer.appendChild(htmlElement);
                },
                onRoomFound: function(room) {
                    var alreadyExist = document.querySelector(
                        'button[data-broadcaster="' + room.broadcaster + '"]'
                    );
                    if (alreadyExist) return;
                    if (typeof roomsList === "undefined") roomsList = document.body;
                    broadcastUI.joinRoom({
                        roomToken: room.broadcaster,
                        joinUser: room.broadcaster,
                    });
                },
                onNewParticipant: function(numberOfViewers) {
                    document.title = "Viewers: " + numberOfViewers;
                },
                onReady: function() {
                    console.log("now you can open or join rooms");
                },
            };

            function setupNewBroadcastButtonClickHandler() {
                document.getElementById("broadcast-name").disabled = true;
                document.getElementById("setup-new-broadcast").disabled = true;
                DetectRTC.load(function() {
                    captureUserMedia(function() {
                        var shared = "video";

                        broadcastUI.createRoom({
                            roomName:
                                (document.getElementById("broadcast-name") || {}).value ||
                                "Anonymous",
                            isAudio: shared === "audio",
                        });
                    });
                    hideUnnecessaryStuff();
                });
            }

            function captureUserMedia(callback) {
                var constraints = null;
                window.option = "video";

                var htmlElement = document.createElement("video");
                htmlElement.muted = true;
                htmlElement.volume = 0;
                try {
                    htmlElement.setAttributeNode(document.createAttribute("autoplay"));
                    htmlElement.setAttributeNode(
                        document.createAttribute("playsinline")
                    );
                    htmlElement.setAttribute("id", "getvideo");
                    htmlElement.setAttributeNode(document.createAttribute("controls"));
                } catch (e) {
                    htmlElement.setAttribute("id", "getvideo");
                    htmlElement.setAttribute("autoplay", true);
                    htmlElement.setAttribute("playsinline", true);
                    htmlElement.setAttribute("controls", true);
                }
                var mediaConfig = {
                    video: htmlElement,
                    onsuccess: function(stream) {
                        config.attachStream = stream;

                        videosContainer.appendChild(htmlElement);

                        callback && callback();
                    },
                    onerror: function() {
                        alert("unable to get access to your webcam");
                    },
                };
                if (constraints) mediaConfig.constraints = constraints;
                getUserMedia(mediaConfig);
            }
            var broadcastUI = broadcast(config);
            /* UI specific */
            var videosContainer =
                document.getElementById("videos-container") || document.body;
            var setupNewBroadcast = document.getElementById("setup-new-broadcast");
            var roomsList = document.getElementById("rooms-list");
            var broadcastingOption = document.getElementById("broadcasting-option");
            if (getUrlVars()["q"] === "start") {
                setupNewBroadcastButtonClickHandler();
            }

            function hideUnnecessaryStuff() {
                var visibleElements = document.getElementsByClassName("visible"),
                    length = visibleElements.length;
                for (var i = 0; i < length; i++) {
                    visibleElements[i].style.display = "none";
                }
            }

            function rotateInCircle(video) {
                video.style[
                    navigator.mozGetUserMedia ? "transform" : "-webkit-transform"
                ] = "rotate(0deg)";
                setTimeout(function() {
                    video.style[
                        navigator.mozGetUserMedia ? "transform" : "-webkit-transform"
                    ] = "rotate(360deg)";
                }, 1000);
            }
        </script>
    </article>
</body>

</html>